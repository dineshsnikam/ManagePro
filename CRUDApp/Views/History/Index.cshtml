@model IEnumerable<ProductHistory>
@{
    ViewBag.Title = "Product History Track";
}

<style>
    /* (Your existing styles here) */
    .table-container {
        height: calc(100vh - 150px);
        overflow-y: auto;
        border: 1px solid var(--bs-border-color);
        transition: border-color 0.3s;
        background-color: var(--main-bg-color);
    }

    thead th {
        position: sticky;
        top: 0;
        z-index: 100;
        background-color: #212529;
        color: white;
        transition: background-color 0.3s, color 0.3s;
    }

    .position {
        background-color: black;
        position: sticky;
        top: 0;
        z-index: 100;
        background: linear-gradient(135deg, #1d3557, #457b7d);
        padding: 1rem;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
        color: white;
        transition: background-color 0.3s, color 0.3s;
    }

    :root {
        /* --main-bg-color: w; */
        /* --main-text-color: #000000; */
    }

    .dark-mode {
        --main-bg-color: #121212;
        --main-text-color: #f1f1f1;
    }

    body {
        background-color: var(--main-bg-color);
        color: var(--main-text-color);
        transition: background-color 0.3s, color 0.3s;
         margin: 0px;
        padding: 0px;
    }

    .form-control, select {
        background-color: var(--main-bg-color);
        color: var(--main-text-color);
        border: 1px solid #6c757d;
    }

    .table td, .table th {
        color: var(--main-text-color);
        background-color: var(--main-bg-color);
    }

    .dark-mode select option {
        background-color: #2c2c2c;
        color: #f8f8f8;
    }
</style>

<div class="fixed-header text-center">
    <h2 class="mb-2">Product History Track</h2>
</div>

<div class="px-3 pb-2">
    <label for="actionFilter" class="form-label">Filter by Action:</label>
    <select id="actionFilter" class="form-select form-select-sm" style="width: 200px;">
        <option value="All">All</option>
        <option value="Update">Update</option>
        <option value="Delete">Delete</option>
    </select>
</div>

<div class="table-container">
    <table class="table table-bordered table-hover" id="historyTable">
        <thead class="text-center position">
            <tr>
                <th>Product Name</th>
                <th>Action Type</th>
                <th>Updated Field</th>
                <th>Old Value</th>
                <th>New Value</th>
                <th>Performed By</th>
                <th>Action Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr class="history-row" data-history-id="@item.Id">
                    <td>@item.ProductName</td>
                    <td>@item.ActionType</td>
                    <td>@item.UpdatedField</td>
                    <td>@item.OldValue</td>
                    <td>@item.NewValue</td>
                    <td>@item.PerformedBy</td>
                    <td>@item.ActionDate.ToString("yyyy-MM-dd HH:mm:ss")</td>
                    <td>
                        <button class="btn btn-sm btn-danger delete-btn" type="button">DeleteHistory</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.7/signalr.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/productHistoryHub")
        .build();

    connection.start().catch(err => console.error(err.toString()));

    connection.on("ReceiveUpdate", function (history) {
        addRow(history, "Update");
    });

    connection.on("ReceiveDelete", function (history) {
        addRow(history, "Delete");
    });

    function addRow(history, actionType) {
        const tableBody = document.querySelector("#historyTable tbody");
        const row = document.createElement("tr");
        row.classList.add("history-row", "table-success");
        row.setAttribute("data-history-id", history.Id);
        row.innerHTML = `
            <td>${history.ProductName}</td>
            <td>${history.ActionType}</td>
            <td>${history.UpdatedField}</td>
            <td>${history.OldValue}</td>
            <td>${history.NewValue}</td>
            <td>${history.PerformedBy}</td>
            <td>${history.ActionDate}</td>
            <td><button class="btn btn-sm btn-danger delete-btn" type="button">DeleteHistory</button></td>
        `;
        tableBody.prepend(row);
    }

    // Filter by action type
    document.getElementById("actionFilter").addEventListener("change", function () {
        const selected = this.value.toLowerCase();
        document.querySelectorAll("#historyTable tbody tr").forEach(row => {
            const type = row.children[1].textContent.toLowerCase();
            row.style.display = (selected === "all" || type === selected) ? "" : "none";
        });
    });

    // Delete button functionality with event delegation
    document.querySelector("#historyTable tbody").addEventListener("click", function(e) {
        if(e.target && e.target.classList.contains("delete-btn")) {
            const row = e.target.closest("tr");
            const historyId = row.getAttribute("data-history-id");

            if (!historyId) {
                alert("History ID not found.");
                return;
            }

            if (confirm("Are you sure you want to delete this history record?")) {
                $.ajax({
                    url: '@Url.Action("DeleteHistory", "Product")', // Controller action for deleting history
                    type: "POST",
                    data: { id: historyId },
                    success: function(response) {
                        if(response.success) {
                            row.remove();
                        } else {
                            alert("Failed to delete history record.");
                        }
                    },
                    error: function() {
                        alert("An error occurred while deleting the history record.");
                    }
                });
            }
        }
    });
</script>
